---
version: "3"

set: [pipefail]
shopt: [globstar]

vars:
  PARALLEL_APPLY: 1
  PARALLEL_DESTROY: 4

tasks:
  default: task --list

  apply:
    desc: Create Talos infrastructure
    vars:
      SUPPRESS_ALERT: "{{ default false .SUPPRESS_ALERT }}"
    cmds:
      - tofu apply -auto-approve -parallelism={{.PARALLEL_APPLY}}
      - |
        {{ if .SUPPRESS_ALERT | contains "false" }}
          {{ if .EXIT_CODE }}
            ntfy_alert.sh --topic "k8s" --title "proxmox:recreate failed" --message "Task proxmox:recreate failed" -at "fail"
          {{else}}
            ntfy_alert.sh --topic "k8s" --title "proxmox:recreate completed" --message "Task proxmox:recreate completed successfully" -at "pass"
          {{end}}
        {{end}}
    preconditions:
      - which tofu
      - sh: "test -f backend.tf"
        msg: "Backend storage config file does not exist. Please run 'task FIXME' first."

  destroy:
    desc: Destroy Talos infrastructure
    vars:
      SUPPRESS_ALERT: "{{ default false .SUPPRESS_ALERT }}"
    cmds:
      - tofu destroy -auto-approve -parallelism={{.PARALLEL_DESTROY}}
      - |
        {{ if .SUPPRESS_ALERT | contains "false" }}
          {{ if .EXIT_CODE }}
            ntfy_alert.sh --topic "k8s" --title "proxmox:recreate failed" --message "Task proxmox:recreate failed" -at "fail"
          {{else}}
            ntfy_alert.sh --topic "k8s" --title "proxmox:recreate completed" --message "Task proxmox:recreate completed successfully" -at "pass"
          {{end}}
        {{end}}
    preconditions:
      - sh: "test -f backend.tf"
        msg: "Backend does not exist. Nothing to destroy."

  recreate:
    desc: Destroy and recreate Talos infrastructure
    vars:
      SUPPRESS_ALERT: "{{ default false .SUPPRESS_ALERT }}"
    cmds:
      - task: destroy
        vars:
          SUPPRESS_ALERT: true
      - sleep 5
      - task: apply
        vars:
          SUPPRESS_ALERT: true
      - |
        {{ if .SUPPRESS_ALERT | contains "false" }}
          {{ if .EXIT_CODE }}
            ntfy_alert.sh --topic "k8s" --title "proxmox:recreate failed" --message "Task proxmox:recreate failed" -at "fail"
          {{else}}
            ntfy_alert.sh --topic "k8s" --title "proxmox:recreate completed" --message "Task proxmox:recreate completed successfully" -at "pass"
          {{end}}
        {{end}}
